<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: MemCache</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "width=400,height=400,scrollbars=yes" )
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />MemCache</td>
  <td align="right">
    <table cellspacing=0 cellpadding=2>
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../files/vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1_7_4/memcache_rb.html">vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
        <a href="Object.html">
Object
         </a>
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
A Ruby client library for memcached.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000142">[]</a></li>
  <li><a href="#M000143">[]=</a></li>
  <li><a href="#M000124">active?</a></li>
  <li><a href="#M000134">add</a></li>
  <li><a href="#M000136">append</a></li>
  <li><a href="#M000147">cache_decr</a></li>
  <li><a href="#M000148">cache_get</a></li>
  <li><a href="#M000150">cache_get_multi</a></li>
  <li><a href="#M000151">cache_incr</a></li>
  <li><a href="#M000133">cas</a></li>
  <li><a href="#M000160">check_multithread_status!</a></li>
  <li><a href="#M000158">create_continuum_for</a></li>
  <li><a href="#M000127">decr</a></li>
  <li><a href="#M000138">delete</a></li>
  <li><a href="#M000159">entry_count_for</a></li>
  <li><a href="#M000129">fetch</a></li>
  <li><a href="#M000139">flush_all</a></li>
  <li><a href="#M000128">get</a></li>
  <li><a href="#M000130">get_multi</a></li>
  <li><a href="#M000146">get_server_for_key</a></li>
  <li><a href="#M000149">gets</a></li>
  <li><a href="#M000154">handle_error</a></li>
  <li><a href="#M000145">hash_for</a></li>
  <li><a href="#M000131">incr</a></li>
  <li><a href="#M000123">inspect</a></li>
  <li><a href="#M000144">make_cache_key</a></li>
  <li><a href="#M000122">new</a></li>
  <li><a href="#M000155">noreply</a></li>
  <li><a href="#M000137">prepend</a></li>
  <li><a href="#M000157">raise_on_error_response!</a></li>
  <li><a href="#M000125">readonly?</a></li>
  <li><a href="#M000135">replace</a></li>
  <li><a href="#M000156">request_setup</a></li>
  <li><a href="#M000140">reset</a></li>
  <li><a href="#M000126">servers=</a></li>
  <li><a href="#M000132">set</a></li>
  <li><a href="#M000141">stats</a></li>
  <li><a href="#M000153">with_server</a></li>
  <li><a href="#M000152">with_socket_management</a></li>
  </ul>



  <div class="sectiontitle">Classes and Modules</div>
  Class <a href="MemCache/MemCacheError.html" class="link">MemCache::MemCacheError</a><br />
Class <a href="MemCache/Server.html" class="link">MemCache::Server</a><br />


  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">VERSION</td>
    <td>=</td>
    <td class="attr-value">'1.7.4'</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
The version of <a href="MemCache.html">MemCache</a> you are using.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">DEFAULT_OPTIONS</td>
    <td>=</td>
    <td class="attr-value">{     :namespace   =&gt; nil,     :readonly    =&gt; false,     :multithread =&gt; true,     :failover    =&gt; true,     :timeout     =&gt; 0.5,     :logger      =&gt; nil,     :no_reply    =&gt; false,   }</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Default options for the cache object.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">DEFAULT_PORT</td>
    <td>=</td>
    <td class="attr-value">11211</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Default memcached port.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">DEFAULT_WEIGHT</td>
    <td>=</td>
    <td class="attr-value">1</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Default memcached server weight.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">ONE_MB</td>
    <td>=</td>
    <td class="attr-value">1024 * 1024</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Add <tt>key</tt> to the cache with value <tt>value</tt> that expires in
<tt>expiry</tt> seconds. If <tt>raw</tt> is true, <tt>value</tt> will not
be Marshalled.

<p>
Warning: Readers should not call this method in the event of a cache miss;
see <a href="MemCache.html#M000134">MemCache#add</a>.
</p>
</td>
  </tr>
  </table>

  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>failover</td>
    <td class='attr-desc'>
Should the client try to failover to another server if the first server is
down? Defaults to true.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>logger</td>
    <td class='attr-desc'>
Log debug/info/warn/error to the given <a href="Logger.html">Logger</a>,
defaults to nil.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>multithread</td>
    <td class='attr-desc'>
The multithread setting for this instance

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>namespace</td>
    <td class='attr-desc'>
The namespace for this instance

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>no_reply</td>
    <td class='attr-desc'>
Don&#8216;t send or look for a reply from the memcached server for write
operations. Please note this feature only works in memcached 1.2.5 and
later. Earlier versions will reply with &quot;ERROR&quot;.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>servers</td>
    <td class='attr-desc'>
The servers this client talks to. Play at your own peril.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>timeout</td>
    <td class='attr-desc'>
Socket timeout limit with this client, defaults to 0.5 sec. Set to nil to
disable timeouts.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000122"></a><b>new</b>(*args)
  </div>
  <div class="description">
  <p>
Accepts a list of <tt>servers</tt> and a list of <tt>opts</tt>.
<tt>servers</tt> may be omitted. See +<a
href="MemCache.html#M000126">servers=</a>+ for acceptable server list
arguments.
</p>
<p>
Valid options for <tt>opts</tt> are:
</p>
<pre>
  [:namespace]   Prepends this value to all keys added or retrieved.
  [:readonly]    Raises an exception on cache writes when true.
  [:multithread] Wraps cache access in a Mutex for thread safety. Defaults to true.
  [:failover]    Should the client try to failover to another server if the
                 first server is down?  Defaults to true.
  [:timeout]     Time to use as the socket read timeout.  Defaults to 0.5 sec,
                 set to nil to disable timeouts (this is a major performance penalty in Ruby 1.8,
                 &quot;gem install SystemTimer' to remove most of the penalty).
  [:logger]      Logger to use for info/debug output, defaults to nil
  [:no_reply]    Don't bother looking for a reply for write operations (i.e. they
                 become 'fire and forget'), memcached 1.2.5 and later only, speeds up
                 set/add/delete/incr/decr significantly.
</pre>
<p>
Other options are ignored.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000122_source')" id="l_M000122_source">show source</a> ]</p>
  <div id="M000122_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 102</span>
102:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
103:     <span class="ruby-identifier">servers</span> = []
104:     <span class="ruby-identifier">opts</span> = {}
105: 
106:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">length</span>
107:     <span class="ruby-keyword kw">when</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-comment cmt"># NOP</span>
108:     <span class="ruby-keyword kw">when</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">then</span>
109:       <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">shift</span>
110:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">arg</span>
111:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Hash</span>   <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">arg</span>
112:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Array</span>  <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">arg</span>
113:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">String</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">servers</span> = [<span class="ruby-identifier">arg</span>]
114:       <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">'first argument must be Array, Hash or String'</span>
115:       <span class="ruby-keyword kw">end</span>
116:     <span class="ruby-keyword kw">when</span> <span class="ruby-value">2</span> <span class="ruby-keyword kw">then</span>
117:       <span class="ruby-identifier">servers</span>, <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">args</span>
118:     <span class="ruby-keyword kw">else</span>
119:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;wrong number of arguments (#{args.length} for 2)&quot;</span>
120:     <span class="ruby-keyword kw">end</span>
121: 
122:     <span class="ruby-identifier">opts</span> = <span class="ruby-constant">DEFAULT_OPTIONS</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">opts</span>
123:     <span class="ruby-ivar">@namespace</span>   = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:namespace</span>]
124:     <span class="ruby-ivar">@readonly</span>    = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:readonly</span>]
125:     <span class="ruby-ivar">@multithread</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:multithread</span>]
126:     <span class="ruby-ivar">@timeout</span>     = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:timeout</span>]
127:     <span class="ruby-ivar">@failover</span>    = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:failover</span>]
128:     <span class="ruby-ivar">@logger</span>      = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:logger</span>]
129:     <span class="ruby-ivar">@no_reply</span>    = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:no_reply</span>]
130:     <span class="ruby-ivar">@mutex</span>       = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multithread</span>
131: 
132:     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> { <span class="ruby-node">&quot;memcache-client #{VERSION} #{Array(servers).inspect}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
133: 
134:     <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:memcache_client</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">object_id</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@multithread</span>
135: 
136:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">servers</span> = <span class="ruby-identifier">servers</span>
137:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000142"></a><b>[]</b>(key, raw = false)
  </div>
  <div class="description">
  <p>
Alias for <a href="MemCache.html#M000128">get</a>
</p>
  </div>
</div>
<div class="method">
  <div class="title">
    <a name="M000143"></a><b>[]=</b>(key, value)
  </div>
  <div class="description">
  <p>
Shortcut to save a value in the cache. This method does not <a
href="MemCache.html#M000132">set</a> an expiration on the entry. Use <a
href="MemCache.html#M000132">set</a> to specify an explicit expiry.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000143_source')" id="l_M000143_source">show source</a> ]</p>
  <div id="M000143_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 613</span>
613:   <span class="ruby-keyword kw">def</span> <span class="ruby-operator">[]=</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
614:     <span class="ruby-identifier">set</span> <span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>
615:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000124"></a><b>active?</b>()
  </div>
  <div class="description">
  <p>
Returns whether there is at least one active server for the object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000124_source')" id="l_M000124_source">show source</a> ]</p>
  <div id="M000124_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 150</span>
150:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">active?</span>
151:     <span class="ruby-keyword kw">not</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">empty?</span>
152:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000134"></a><b>add</b>(key, value, expiry = 0, raw = false)
  </div>
  <div class="description">
  <p>
Add <tt>key</tt> to the cache with value <tt>value</tt> that expires in
<tt>expiry</tt> seconds, but only if <tt>key</tt> does not already exist in
the cache. If <tt>raw</tt> is true, <tt>value</tt> will not be Marshalled.
</p>
<p>
Readers should call this method in the event of a cache miss, not <a
href="MemCache.html#M000132">MemCache#set</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000134_source')" id="l_M000134_source">show source</a> ]</p>
  <div id="M000134_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 393</span>
393:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">expiry</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
394:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
395:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
396:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
397:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;add #{key} to #{server}: #{value ? value.to_s.size : 'nil'}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
398:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;add #{cache_key} 0 #{expiry} #{value.to_s.size}#{noreply}\r\n#{value}\r\n&quot;</span>
399: 
400:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
401:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
402:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
403:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
404:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
405:         <span class="ruby-identifier">result</span>
406:       <span class="ruby-keyword kw">end</span>
407:     <span class="ruby-keyword kw">end</span>
408:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000136"></a><b>append</b>(key, value)
  </div>
  <div class="description">
  <p>
Append - &#8216;<a href="MemCache.html#M000134">add</a> this data to an
existing key after existing data&#8217; Please note the value is always
passed to memcached as raw since it doesn&#8216;t make a lot of sense to
concatenate marshalled data together.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000136_source')" id="l_M000136_source">show source</a> ]</p>
  <div id="M000136_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 435</span>
435:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">append</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
436:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
437:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
438:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;append #{key} to #{server}: #{value ? value.to_s.size : 'nil'}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
439:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;append #{cache_key} 0 0 #{value.to_s.size}#{noreply}\r\n#{value}\r\n&quot;</span>
440: 
441:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
442:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
443:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
444:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
445:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
446:         <span class="ruby-identifier">result</span>
447:       <span class="ruby-keyword kw">end</span>
448:     <span class="ruby-keyword kw">end</span>
449:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000133"></a><b>cas</b>(key, expiry=0, raw=false) {|value| ...}
  </div>
  <div class="description">
  <p>
&quot;<a href="MemCache.html#M000133">cas</a>&quot; is a check and <a
href="MemCache.html#M000132">set</a> operation which means &quot;store this
data but only if no one else has updated since I last fetched it.&quot;
This can be used as a form of optimistic locking.
</p>
<p>
Works in block form like so:
</p>
<pre>
  cache.cas('some-key') do |value|
    value + 1
  end
</pre>
<p>
Returns: <tt>nil</tt> if the value was not found on the memcached server.
<tt>STORED</tt> if the value was updated successfully <tt>EXISTS</tt> if
the value was updated by someone else since last <a
href="MemCache.html#M000129">fetch</a>
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000133_source')" id="l_M000133_source">show source</a> ]</p>
  <div id="M000133_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 355</span>
355:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cas</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">expiry</span>=<span class="ruby-value">0</span>, <span class="ruby-identifier">raw</span>=<span class="ruby-keyword kw">false</span>)
356:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
357:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;A block is required&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block_given?</span>
358: 
359:     (<span class="ruby-identifier">value</span>, <span class="ruby-identifier">token</span>) = <span class="ruby-identifier">gets</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">raw</span>)
360:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">value</span>
361:     <span class="ruby-identifier">updated</span> = <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">value</span>
362: 
363:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
364: 
365:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">updated</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
366:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;cas #{key} to #{server.inspect}: #{value.to_s.size}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
367:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;cas #{cache_key} 0 #{expiry} #{value.to_s.size} #{token}#{noreply}\r\n#{value}\r\n&quot;</span>
368: 
369:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
370:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
371:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
372:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
373:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
374: 
375:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">nil?</span>
376:           <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
377:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;lost connection to #{server.host}:#{server.port}&quot;</span>
378:         <span class="ruby-keyword kw">end</span>
379: 
380:         <span class="ruby-identifier">result</span>
381:       <span class="ruby-keyword kw">end</span>
382:     <span class="ruby-keyword kw">end</span>
383:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000127"></a><b>decr</b>(key, amount = 1)
  </div>
  <div class="description">
  <p>
Decrements the value for <tt>key</tt> by <tt>amount</tt> and returns the <a
href="MemCache.html#M000122">new</a> value. <tt>key</tt> must already
exist. If <tt>key</tt> is not an integer, it is assumed to be
</p>
<ol>
<li><tt>key</tt> can not be decremented below 0.

</li>
</ol>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000127_source')" id="l_M000127_source">show source</a> ]</p>
  <div id="M000127_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 193</span>
193:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decr</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">amount</span> = <span class="ruby-value">1</span>)
194:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
195:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
196:       <span class="ruby-identifier">cache_decr</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>, <span class="ruby-identifier">amount</span>
197:     <span class="ruby-keyword kw">end</span>
198:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
199:     <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
200:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000138"></a><b>delete</b>(key, expiry = 0)
  </div>
  <div class="description">
  <p>
Removes <tt>key</tt> from the cache in <tt>expiry</tt> seconds.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000138_source')" id="l_M000138_source">show source</a> ]</p>
  <div id="M000138_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 474</span>
474:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">expiry</span> = <span class="ruby-value">0</span>)
475:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
476:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
477:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
478:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;delete #{cache_key} on #{server}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
479:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;delete #{cache_key} #{expiry}#{noreply}\r\n&quot;</span>
480:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
481:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
482:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
483:         <span class="ruby-identifier">result</span>
484:       <span class="ruby-keyword kw">end</span>
485:     <span class="ruby-keyword kw">end</span>
486:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000129"></a><b>fetch</b>(key, expiry = 0, raw = false) {|| ...}
  </div>
  <div class="description">
  <p>
Performs a <tt><a href="MemCache.html#M000128">get</a></tt> with the given
<tt>key</tt>. If the value does not exist and a block was given, the block
will be called and the result saved via <tt><a
href="MemCache.html#M000134">add</a></tt>.
</p>
<p>
If you do not provide a block, using this method is the same as using
<tt><a href="MemCache.html#M000128">get</a></tt>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000129_source')" id="l_M000129_source">show source</a> ]</p>
  <div id="M000129_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 226</span>
226:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">expiry</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
227:     <span class="ruby-identifier">value</span> = <span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">raw</span>)
228: 
229:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block_given?</span>
230:       <span class="ruby-identifier">value</span> = <span class="ruby-keyword kw">yield</span>
231:       <span class="ruby-identifier">add</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">expiry</span>, <span class="ruby-identifier">raw</span>)
232:     <span class="ruby-keyword kw">end</span>
233: 
234:     <span class="ruby-identifier">value</span>
235:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000139"></a><b>flush_all</b>(delay=0)
  </div>
  <div class="description">
  <p>
Flush the cache from all memcache servers. A non-zero value for
<tt>delay</tt> will ensure that the flush is propogated slowly through your
memcached server farm. The Nth server will be flushed N*delay seconds from
now, asynchronously so this method returns quickly. This prevents a huge
database spike due to a total flush all at once.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000139_source')" id="l_M000139_source">show source</a> ]</p>
  <div id="M000139_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 497</span>
497:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">flush_all</span>(<span class="ruby-identifier">delay</span>=<span class="ruby-value">0</span>)
498:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">'No active servers'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">active?</span>
499:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
500: 
501:     <span class="ruby-keyword kw">begin</span>
502:       <span class="ruby-identifier">delay_time</span> = <span class="ruby-value">0</span>
503:       <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
504:         <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
505:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;flush_all #{delay_time} on #{server}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
506:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delay</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># older versions of memcached will fail silently otherwise</span>
507:             <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;flush_all#{noreply}\r\n&quot;</span>
508:           <span class="ruby-keyword kw">else</span>
509:             <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;flush_all #{delay_time}#{noreply}\r\n&quot;</span>
510:           <span class="ruby-keyword kw">end</span>
511:           <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
512:           <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
513:           <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
514:           <span class="ruby-identifier">result</span>
515:         <span class="ruby-keyword kw">end</span>
516:         <span class="ruby-identifier">delay_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">delay</span>
517:       <span class="ruby-keyword kw">end</span>
518:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IndexError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
519:       <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
520:     <span class="ruby-keyword kw">end</span>
521:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000128"></a><b>get</b>(key, raw = false)
  </div>
  <div class="description">
  <p>
Retrieves <tt>key</tt> from memcache. If <tt>raw</tt> is false, the value
will be unmarshalled.
</p>
  </div>
<div class="aka">
  This method is also aliased as
  <a href="MemCache.html#M000142">[]</a>
</div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000128_source')" id="l_M000128_source">show source</a> ]</p>
  <div id="M000128_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 206</span>
206:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
207:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
208:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;get #{key} from #{server.inspect}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
209:       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">cache_get</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>
210:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
211:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
212:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">value</span>
213:     <span class="ruby-keyword kw">end</span>
214:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
215:     <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
216:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000130"></a><b>get_multi</b>(*keys)
  </div>
  <div class="description">
  <p>
Retrieves multiple values from memcached in parallel, if possible.
</p>
<p>
The memcached protocol supports the ability to retrieve multiple keys in a
single request. Pass in an array of keys to this method and it will:
</p>
<ol>
<li>map the key to the appropriate memcached server

</li>
<li>send a single request to each server that has one or more key values

</li>
</ol>
<p>
Returns a hash of values.
</p>
<pre>
  cache[&quot;a&quot;] = 1
  cache[&quot;b&quot;] = 2
  cache.get_multi &quot;a&quot;, &quot;b&quot; # =&gt; { &quot;a&quot; =&gt; 1, &quot;b&quot; =&gt; 2 }
</pre>
<p>
Note that <a href="MemCache.html#M000130">get_multi</a> assumes the values
are marshalled.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000130_source')" id="l_M000130_source">show source</a> ]</p>
  <div id="M000130_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 255</span>
255:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_multi</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">keys</span>)
256:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">'No active servers'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">active?</span>
257: 
258:     <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">flatten!</span>
259:     <span class="ruby-identifier">key_count</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">length</span>
260:     <span class="ruby-identifier">cache_keys</span> = {}
261:     <span class="ruby-identifier">server_keys</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,<span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>] = [] }
262: 
263:     <span class="ruby-comment cmt"># map keys to servers</span>
264:     <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
265:       <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span> = <span class="ruby-identifier">request_setup</span> <span class="ruby-identifier">key</span>
266:       <span class="ruby-identifier">cache_keys</span>[<span class="ruby-identifier">cache_key</span>] = <span class="ruby-identifier">key</span>
267:       <span class="ruby-identifier">server_keys</span>[<span class="ruby-identifier">server</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">cache_key</span>
268:     <span class="ruby-keyword kw">end</span>
269: 
270:     <span class="ruby-identifier">results</span> = {}
271: 
272:     <span class="ruby-identifier">server_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">keys_for_server</span><span class="ruby-operator">|</span>
273:       <span class="ruby-identifier">keys_for_server_str</span> = <span class="ruby-identifier">keys_for_server</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">' '</span>
274:       <span class="ruby-keyword kw">begin</span>
275:         <span class="ruby-identifier">values</span> = <span class="ruby-identifier">cache_get_multi</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">keys_for_server_str</span>
276:         <span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
277:           <span class="ruby-identifier">results</span>[<span class="ruby-identifier">cache_keys</span>[<span class="ruby-identifier">key</span>]] = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-identifier">value</span>
278:         <span class="ruby-keyword kw">end</span>
279:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IndexError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
280:         <span class="ruby-comment cmt"># Ignore this server and try the others</span>
281:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> { <span class="ruby-node">&quot;Unable to retrieve #{keys_for_server.size} elements from #{server.inspect}: #{e.message}&quot;</span>} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
282:       <span class="ruby-keyword kw">end</span>
283:     <span class="ruby-keyword kw">end</span>
284: 
285:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">results</span>
286:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
287:     <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
288:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000131"></a><b>incr</b>(key, amount = 1)
  </div>
  <div class="description">
  <p>
Increments the value for <tt>key</tt> by <tt>amount</tt> and returns the <a
href="MemCache.html#M000122">new</a> value. <tt>key</tt> must already
exist. If <tt>key</tt> is not an integer, it is assumed to be 0.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000131_source')" id="l_M000131_source">show source</a> ]</p>
  <div id="M000131_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 295</span>
295:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">incr</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">amount</span> = <span class="ruby-value">1</span>)
296:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
297:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
298:       <span class="ruby-identifier">cache_incr</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>, <span class="ruby-identifier">amount</span>
299:     <span class="ruby-keyword kw">end</span>
300:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
301:     <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
302:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000123"></a><b>inspect</b>()
  </div>
  <div class="description">
  <p>
Returns a string representation of the cache object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000123_source')" id="l_M000123_source">show source</a> ]</p>
  <div id="M000123_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 142</span>
142:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inspect</span>
143:     <span class="ruby-value str">&quot;&lt;MemCache: %d servers, ns: %p, ro: %p&gt;&quot;</span> <span class="ruby-operator">%</span>
144:       [<span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">length</span>, <span class="ruby-ivar">@namespace</span>, <span class="ruby-ivar">@readonly</span>]
145:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000137"></a><b>prepend</b>(key, value)
  </div>
  <div class="description">
  <p>
Prepend - &#8216;<a href="MemCache.html#M000134">add</a> this data to an
existing key before existing data&#8217; Please note the value is always
passed to memcached as raw since it doesn&#8216;t make a lot of sense to
concatenate marshalled data together.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000137_source')" id="l_M000137_source">show source</a> ]</p>
  <div id="M000137_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 455</span>
455:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepend</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
456:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
457:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
458:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;prepend #{key} to #{server}: #{value ? value.to_s.size : 'nil'}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
459:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;prepend #{cache_key} 0 0 #{value.to_s.size}#{noreply}\r\n#{value}\r\n&quot;</span>
460: 
461:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
462:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
463:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
464:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
465:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
466:         <span class="ruby-identifier">result</span>
467:       <span class="ruby-keyword kw">end</span>
468:     <span class="ruby-keyword kw">end</span>
469:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000125"></a><b>readonly?</b>()
  </div>
  <div class="description">
  <p>
Returns whether or not the cache object was created read only.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000125_source')" id="l_M000125_source">show source</a> ]</p>
  <div id="M000125_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 157</span>
157:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">readonly?</span>
158:     <span class="ruby-ivar">@readonly</span>
159:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000135"></a><b>replace</b>(key, value, expiry = 0, raw = false)
  </div>
  <div class="description">
  <p>
Add <tt>key</tt> to the cache with value <tt>value</tt> that expires in
<tt>expiry</tt> seconds, but only if <tt>key</tt> already exists in the
cache. If <tt>raw</tt> is true, <tt>value</tt> will not be Marshalled.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000135_source')" id="l_M000135_source">show source</a> ]</p>
  <div id="M000135_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 414</span>
414:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">replace</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">expiry</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
415:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
416:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
417:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
418:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;replace #{key} to #{server}: #{value ? value.to_s.size : 'nil'}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
419:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;replace #{cache_key} 0 #{expiry} #{value.to_s.size}#{noreply}\r\n#{value}\r\n&quot;</span>
420: 
421:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
422:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
423:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
424:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
425:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
426:         <span class="ruby-identifier">result</span>
427:       <span class="ruby-keyword kw">end</span>
428:     <span class="ruby-keyword kw">end</span>
429:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000140"></a><b>reset</b>()
  </div>
  <div class="description">
  <p>
Reset the connection to all memcache servers. This should be called if
there is a problem with a cache lookup that might have left the connection
in a corrupted state.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000140_source')" id="l_M000140_source">show source</a> ]</p>
  <div id="M000140_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 528</span>
528:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset</span>
529:     <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span> }
530:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000126"></a><b>servers=</b>(servers)
  </div>
  <div class="description">
  <p>
Set the servers that the requests will be distributed between. Entries can
be either strings of the form &quot;hostname:port&quot; or
&quot;hostname:port:weight&quot; or <a
href="MemCache/Server.html">MemCache::Server</a> objects.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000126_source')" id="l_M000126_source">show source</a> ]</p>
  <div id="M000126_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 166</span>
166:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">servers=</span>(<span class="ruby-identifier">servers</span>)
167:     <span class="ruby-comment cmt"># Create the server objects.</span>
168:     <span class="ruby-ivar">@servers</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">servers</span>).<span class="ruby-identifier">collect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
169:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">server</span>
170:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">String</span>
171:         <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">weight</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">split</span> <span class="ruby-value str">':'</span>, <span class="ruby-value">3</span>
172:         <span class="ruby-identifier">port</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">DEFAULT_PORT</span>
173:         <span class="ruby-identifier">weight</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">DEFAULT_WEIGHT</span>
174:         <span class="ruby-constant">Server</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">weight</span>
175:       <span class="ruby-keyword kw">else</span>
176:         <span class="ruby-identifier">server</span>
177:       <span class="ruby-keyword kw">end</span>
178:     <span class="ruby-keyword kw">end</span>
179: 
180:     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;Servers now: #{@servers.inspect}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
181: 
182:     <span class="ruby-comment cmt"># There's no point in doing this if there's only one server</span>
183:     <span class="ruby-ivar">@continuum</span> = <span class="ruby-identifier">create_continuum_for</span>(<span class="ruby-ivar">@servers</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
184: 
185:     <span class="ruby-ivar">@servers</span>
186:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000132"></a><b>set</b>(key, value, expiry = 0, raw = false)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000132_source')" id="l_M000132_source">show source</a> ]</p>
  <div id="M000132_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 313</span>
313:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">expiry</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
314:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Update of readonly cache&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readonly</span>
315:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
316: 
317:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
318:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;set #{key} to #{server.inspect}: #{value.to_s.size}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
319: 
320:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;Value too large, memcached can only store 1MB of data per key&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ONE_MB</span>
321: 
322:       <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;set #{cache_key} 0 #{expiry} #{value.to_s.size}#{noreply}\r\n#{value}\r\n&quot;</span>
323: 
324:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
325:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">command</span>
326:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
327:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
328:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">result</span>
329: 
330:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">nil?</span>
331:           <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
332:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;lost connection to #{server.host}:#{server.port}&quot;</span>
333:         <span class="ruby-keyword kw">end</span>
334: 
335:         <span class="ruby-identifier">result</span>
336:       <span class="ruby-keyword kw">end</span>
337:     <span class="ruby-keyword kw">end</span>
338:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000141"></a><b>stats</b>()
  </div>
  <div class="description">
  <p>
Returns statistics for each memcached server. An explanation of the
statistics can be found in the memcached docs:
</p>
<p>
<a
href="http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt">code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt</a>
</p>
<p>
Example:
</p>
<pre>
  &gt;&gt; pp CACHE.stats
  {&quot;localhost:11211&quot;=&gt;
    {&quot;bytes&quot;=&gt;4718,
     &quot;pid&quot;=&gt;20188,
     &quot;connection_structures&quot;=&gt;4,
     &quot;time&quot;=&gt;1162278121,
     &quot;pointer_size&quot;=&gt;32,
     &quot;limit_maxbytes&quot;=&gt;67108864,
     &quot;cmd_get&quot;=&gt;14532,
     &quot;version&quot;=&gt;&quot;1.2.0&quot;,
     &quot;bytes_written&quot;=&gt;432583,
     &quot;cmd_set&quot;=&gt;32,
     &quot;get_misses&quot;=&gt;0,
     &quot;total_connections&quot;=&gt;19,
     &quot;curr_connections&quot;=&gt;3,
     &quot;curr_items&quot;=&gt;4,
     &quot;uptime&quot;=&gt;1557,
     &quot;get_hits&quot;=&gt;14532,
     &quot;total_items&quot;=&gt;32,
     &quot;rusage_system&quot;=&gt;0.313952,
     &quot;rusage_user&quot;=&gt;0.119981,
     &quot;bytes_read&quot;=&gt;190619}}
  =&gt; nil
</pre>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000141_source')" id="l_M000141_source">show source</a> ]</p>
  <div id="M000141_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 564</span>
564:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stats</span>
565:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;No active servers&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">active?</span>
566:     <span class="ruby-identifier">server_stats</span> = {}
567: 
568:     <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
569:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">alive?</span>
570: 
571:       <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
572:         <span class="ruby-identifier">value</span> = <span class="ruby-keyword kw">nil</span>
573:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-value str">&quot;stats\r\n&quot;</span>
574:         <span class="ruby-identifier">stats</span> = {}
575:         <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">line</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span> <span class="ruby-keyword kw">do</span>
576:           <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">line</span>
577:           <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;END\r\n&quot;</span>
578:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\ASTAT ([\S]+) ([\w\.\:]+)/</span> <span class="ruby-keyword kw">then</span>
579:             <span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">$1</span>, <span class="ruby-identifier">$2</span>
580:             <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">name</span>
581:                           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'version'</span>
582:                             <span class="ruby-identifier">value</span>
583:                           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'rusage_user'</span>, <span class="ruby-value str">'rusage_system'</span> <span class="ruby-keyword kw">then</span>
584:                             <span class="ruby-identifier">seconds</span>, <span class="ruby-identifier">microseconds</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/:/</span>, <span class="ruby-value">2</span>)
585:                             <span class="ruby-identifier">microseconds</span> <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
586:                             <span class="ruby-constant">Float</span>(<span class="ruby-identifier">seconds</span>) <span class="ruby-operator">+</span> (<span class="ruby-constant">Float</span>(<span class="ruby-identifier">microseconds</span>) <span class="ruby-operator">/</span> <span class="ruby-value">1_000_000</span>)
587:                           <span class="ruby-keyword kw">else</span>
588:                             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\A\d+\Z/</span> <span class="ruby-keyword kw">then</span>
589:                               <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>
590:                             <span class="ruby-keyword kw">else</span>
591:                               <span class="ruby-identifier">value</span>
592:                             <span class="ruby-keyword kw">end</span>
593:                           <span class="ruby-keyword kw">end</span>
594:           <span class="ruby-keyword kw">end</span>
595:         <span class="ruby-keyword kw">end</span>
596:         <span class="ruby-identifier">server_stats</span>[<span class="ruby-node">&quot;#{server.host}:#{server.port}&quot;</span>] = <span class="ruby-identifier">stats</span>
597:       <span class="ruby-keyword kw">end</span>
598:     <span class="ruby-keyword kw">end</span>
599: 
600:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;No active servers&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server_stats</span>.<span class="ruby-identifier">empty?</span>
601:     <span class="ruby-identifier">server_stats</span>
602:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Protected Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000147"></a><b>cache_decr</b>(server, cache_key, amount)
  </div>
  <div class="description">
  <p>
Performs a raw <a href="MemCache.html#M000127">decr</a> for
<tt>cache_key</tt> from <tt>server</tt>. Returns nil if not found.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000147_source')" id="l_M000147_source">show source</a> ]</p>
  <div id="M000147_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 666</span>
666:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_decr</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>, <span class="ruby-identifier">amount</span>)
667:     <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
668:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;decr #{cache_key} #{amount}#{noreply}\r\n&quot;</span>
669:       <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
670:       <span class="ruby-identifier">text</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
671:       <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">text</span>
672:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">text</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;NOT_FOUND\r\n&quot;</span>
673:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">to_i</span>
674:     <span class="ruby-keyword kw">end</span>
675:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000148"></a><b>cache_get</b>(server, cache_key)
  </div>
  <div class="description">
  <p>
Fetches the raw data for <tt>cache_key</tt> from <tt>server</tt>. Returns
nil on cache miss.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000148_source')" id="l_M000148_source">show source</a> ]</p>
  <div id="M000148_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 681</span>
681:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_get</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>)
682:     <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
683:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;get #{cache_key}\r\n&quot;</span>
684:       <span class="ruby-identifier">keyline</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span> <span class="ruby-comment cmt"># &quot;VALUE &lt;key&gt; &lt;flags&gt; &lt;bytes&gt;\r\n&quot;</span>
685: 
686:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keyline</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
687:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
688:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;lost connection to #{server.host}:#{server.port}&quot;</span>
689:       <span class="ruby-keyword kw">end</span>
690: 
691:       <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">keyline</span>
692:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;END\r\n&quot;</span>
693: 
694:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/(\d+)\r/</span> <span class="ruby-keyword kw">then</span>
695:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
696:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;unexpected response #{keyline.inspect}&quot;</span>
697:       <span class="ruby-keyword kw">end</span>
698:       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span> <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">to_i</span>
699:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt"># &quot;\r\n&quot;</span>
700:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>   <span class="ruby-comment cmt"># &quot;END\r\n&quot;</span>
701:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">value</span>
702:     <span class="ruby-keyword kw">end</span>
703:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000150"></a><b>cache_get_multi</b>(server, cache_keys)
  </div>
  <div class="description">
  <p>
Fetches <tt>cache_keys</tt> from <tt>server</tt> using a multi-<a
href="MemCache.html#M000128">get</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000150_source')" id="l_M000150_source">show source</a> ]</p>
  <div id="M000150_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 740</span>
740:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_get_multi</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_keys</span>)
741:     <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
742:       <span class="ruby-identifier">values</span> = {}
743:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;get #{cache_keys}\r\n&quot;</span>
744: 
745:       <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">keyline</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span> <span class="ruby-keyword kw">do</span>
746:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">values</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;END\r\n&quot;</span>
747:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">keyline</span>
748: 
749:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\AVALUE (.+) (.+) (.+)/</span> <span class="ruby-keyword kw">then</span>
750:           <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
751:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;unexpected response #{keyline.inspect}&quot;</span>
752:         <span class="ruby-keyword kw">end</span>
753: 
754:         <span class="ruby-identifier">key</span>, <span class="ruby-identifier">data_length</span> = <span class="ruby-identifier">$1</span>, <span class="ruby-identifier">$3</span>
755:         <span class="ruby-identifier">values</span>[<span class="ruby-identifier">$1</span>] = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span> <span class="ruby-identifier">data_length</span>.<span class="ruby-identifier">to_i</span>
756:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span>(<span class="ruby-value">2</span>) <span class="ruby-comment cmt"># &quot;\r\n&quot;</span>
757:       <span class="ruby-keyword kw">end</span>
758: 
759:       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
760:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;lost connection to #{server.host}:#{server.port}&quot;</span> <span class="ruby-comment cmt"># TODO: retry here too</span>
761:     <span class="ruby-keyword kw">end</span>
762:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000151"></a><b>cache_incr</b>(server, cache_key, amount)
  </div>
  <div class="description">
  <p>
Performs a raw <a href="MemCache.html#M000131">incr</a> for
<tt>cache_key</tt> from <tt>server</tt>. Returns nil if not found.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000151_source')" id="l_M000151_source">show source</a> ]</p>
  <div id="M000151_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 768</span>
768:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_incr</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>, <span class="ruby-identifier">amount</span>)
769:     <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
770:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;incr #{cache_key} #{amount}#{noreply}\r\n&quot;</span>
771:       <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_reply</span>
772:       <span class="ruby-identifier">text</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>
773:       <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">text</span>
774:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">text</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;NOT_FOUND\r\n&quot;</span>
775:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">to_i</span>
776:     <span class="ruby-keyword kw">end</span>
777:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000160"></a><b>check_multithread_status!</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000160_source')" id="l_M000160_source">show source</a> ]</p>
  <div id="M000160_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 891</span>
891:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_multithread_status!</span>
892:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multithread</span>
893: 
894:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:memcache_client</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">object_id</span>
895:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;You are accessing this memcache-client instance from multiple threads but have not enabled multithread support.\nNormally:  MemCache.new(['localhost:11211'], :multithread =&gt; true)\nIn Rails:  config.cache_store = [:mem_cache_store, 'localhost:11211', { :multithread =&gt; true }]\n&quot;</span>
896:     <span class="ruby-keyword kw">end</span>
897:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000158"></a><b>create_continuum_for</b>(servers)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000158_source')" id="l_M000158_source">show source</a> ]</p>
  <div id="M000158_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 872</span>
872:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_continuum_for</span>(<span class="ruby-identifier">servers</span>)
873:     <span class="ruby-identifier">total_weight</span> = <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">memo</span>, <span class="ruby-identifier">srv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">memo</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">srv</span>.<span class="ruby-identifier">weight</span> }
874:     <span class="ruby-identifier">continuum</span> = []
875: 
876:     <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
877:       <span class="ruby-identifier">entry_count_for</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">total_weight</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
878:         <span class="ruby-identifier">hash</span> = <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">SHA1</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-node">&quot;#{server.host}:#{server.port}:#{idx}&quot;</span>)
879:         <span class="ruby-identifier">value</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-node">&quot;0x#{hash[0..7]}&quot;</span>)
880:         <span class="ruby-identifier">continuum</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Continuum</span><span class="ruby-operator">::</span><span class="ruby-constant">Entry</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">value</span>, <span class="ruby-identifier">server</span>)
881:       <span class="ruby-keyword kw">end</span>
882:     <span class="ruby-keyword kw">end</span>
883: 
884:     <span class="ruby-identifier">continuum</span>.<span class="ruby-identifier">sort</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">value</span> }
885:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000159"></a><b>entry_count_for</b>(server, total_servers, total_weight)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000159_source')" id="l_M000159_source">show source</a> ]</p>
  <div id="M000159_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 887</span>
887:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">entry_count_for</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">total_servers</span>, <span class="ruby-identifier">total_weight</span>)
888:     ((<span class="ruby-identifier">total_servers</span> <span class="ruby-operator">*</span> <span class="ruby-constant">Continuum</span><span class="ruby-operator">::</span><span class="ruby-constant">POINTS_PER_SERVER</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">weight</span>) <span class="ruby-operator">/</span> <span class="ruby-constant">Float</span>(<span class="ruby-identifier">total_weight</span>)).<span class="ruby-identifier">floor</span>
889:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000146"></a><b>get_server_for_key</b>(key, options = {})
  </div>
  <div class="description">
  <p>
Pick a server to handle the request based on a hash of the key.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000146_source')" id="l_M000146_source">show source</a> ]</p>
  <div id="M000146_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 642</span>
642:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_server_for_key</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">options</span> = {})
643:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;illegal character in key #{key.inspect}&quot;</span> <span class="ruby-keyword kw">if</span>
644:       <span class="ruby-identifier">key</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\s/</span>
645:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;key too long #{key.inspect}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">250</span>
646:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;No servers available&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">empty?</span>
647:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
648: 
649:     <span class="ruby-identifier">hkey</span> = <span class="ruby-identifier">hash_for</span>(<span class="ruby-identifier">key</span>)
650: 
651:     <span class="ruby-value">20</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">try</span><span class="ruby-operator">|</span>
652:       <span class="ruby-identifier">entryidx</span> = <span class="ruby-constant">Continuum</span>.<span class="ruby-identifier">binary_search</span>(<span class="ruby-ivar">@continuum</span>, <span class="ruby-identifier">hkey</span>)
653:       <span class="ruby-identifier">server</span> = <span class="ruby-ivar">@continuum</span>[<span class="ruby-identifier">entryidx</span>].<span class="ruby-identifier">server</span>
654:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">server</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">alive?</span>
655:       <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">failover</span>
656:       <span class="ruby-identifier">hkey</span> = <span class="ruby-identifier">hash_for</span> <span class="ruby-node">&quot;#{try}#{key}&quot;</span>
657:     <span class="ruby-keyword kw">end</span>
658:     
659:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">&quot;No servers available&quot;</span>
660:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000149"></a><b>gets</b>(key, raw = false)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000149_source')" id="l_M000149_source">show source</a> ]</p>
  <div id="M000149_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 705</span>
705:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gets</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">raw</span> = <span class="ruby-keyword kw">false</span>)
706:     <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span><span class="ruby-operator">|</span>
707:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;gets #{key} from #{server.inspect}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
708:       <span class="ruby-identifier">result</span> = <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">socket</span><span class="ruby-operator">|</span>
709:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">write</span> <span class="ruby-node">&quot;gets #{cache_key}\r\n&quot;</span>
710:         <span class="ruby-identifier">keyline</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span> <span class="ruby-comment cmt"># &quot;VALUE &lt;key&gt; &lt;flags&gt; &lt;bytes&gt; &lt;cas token&gt;\r\n&quot;</span>
711: 
712:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keyline</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
713:           <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
714:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;lost connection to #{server.host}:#{server.port}&quot;</span>
715:         <span class="ruby-keyword kw">end</span>
716: 
717:         <span class="ruby-identifier">raise_on_error_response!</span> <span class="ruby-identifier">keyline</span>
718:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;END\r\n&quot;</span>
719: 
720:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keyline</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/(\d+) (\w+)\r/</span> <span class="ruby-keyword kw">then</span>
721:           <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span>
722:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-node">&quot;unexpected response #{keyline.inspect}&quot;</span>
723:         <span class="ruby-keyword kw">end</span>
724:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span> <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">to_i</span>
725:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">read</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt"># &quot;\r\n&quot;</span>
726:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">gets</span>   <span class="ruby-comment cmt"># &quot;END\r\n&quot;</span>
727:         [<span class="ruby-identifier">value</span>, <span class="ruby-identifier">$2</span>]
728:       <span class="ruby-keyword kw">end</span>
729:       <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">raw</span>
730:       <span class="ruby-identifier">result</span>
731:     <span class="ruby-keyword kw">end</span>
732:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
733:     <span class="ruby-identifier">handle_error</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">err</span>
734:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000154"></a><b>handle_error</b>(server, error)
  </div>
  <div class="description">
  <p>
Handles <tt>error</tt> from <tt>server</tt>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000154_source')" id="l_M000154_source">show source</a> ]</p>
  <div id="M000154_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 843</span>
843:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_error</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">error</span>)
844:     <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">MemCacheError</span>)
845:     <span class="ruby-identifier">server</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>
846:     <span class="ruby-identifier">new_error</span> = <span class="ruby-constant">MemCacheError</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">message</span>
847:     <span class="ruby-identifier">new_error</span>.<span class="ruby-identifier">set_backtrace</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">backtrace</span>
848:     <span class="ruby-identifier">raise</span> <span class="ruby-identifier">new_error</span>
849:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000145"></a><b>hash_for</b>(key)
  </div>
  <div class="description">
  <p>
Returns an interoperable hash value for <tt>key</tt>. (I think, docs are
sketchy for down servers).
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000145_source')" id="l_M000145_source">show source</a> ]</p>
  <div id="M000145_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 635</span>
635:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hash_for</span>(<span class="ruby-identifier">key</span>)
636:     <span class="ruby-constant">Zlib</span>.<span class="ruby-identifier">crc32</span>(<span class="ruby-identifier">key</span>)
637:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000144"></a><b>make_cache_key</b>(key)
  </div>
  <div class="description">
  <p>
Create a key for the cache, incorporating the namespace qualifier if
requested.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000144_source')" id="l_M000144_source">show source</a> ]</p>
  <div id="M000144_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 623</span>
623:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">make_cache_key</span>(<span class="ruby-identifier">key</span>)
624:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">namespace</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
625:       <span class="ruby-identifier">key</span>
626:     <span class="ruby-keyword kw">else</span>
627:       <span class="ruby-node">&quot;#{@namespace}:#{key}&quot;</span>
628:     <span class="ruby-keyword kw">end</span>
629:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000155"></a><b>noreply</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000155_source')" id="l_M000155_source">show source</a> ]</p>
  <div id="M000155_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 851</span>
851:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">noreply</span>
852:     <span class="ruby-ivar">@no_reply</span> <span class="ruby-operator">?</span> <span class="ruby-value str">' noreply'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>
853:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000157"></a><b>raise_on_error_response!</b>(response)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000157_source')" id="l_M000157_source">show source</a> ]</p>
  <div id="M000157_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 866</span>
866:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">raise_on_error_response!</span>(<span class="ruby-identifier">response</span>)
867:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\A(?:CLIENT_|SERVER_)?ERROR(.*)/</span>
868:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">strip</span>
869:     <span class="ruby-keyword kw">end</span>
870:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000156"></a><b>request_setup</b>(key)
  </div>
  <div class="description">
  <p>
Performs setup for making a request with <tt>key</tt> from memcached.
Returns the server to <a href="MemCache.html#M000129">fetch</a> the key
from and the complete key to use.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000156_source')" id="l_M000156_source">show source</a> ]</p>
  <div id="M000156_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 859</span>
859:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">request_setup</span>(<span class="ruby-identifier">key</span>)
860:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-value str">'No active servers'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">active?</span>
861:     <span class="ruby-identifier">cache_key</span> = <span class="ruby-identifier">make_cache_key</span> <span class="ruby-identifier">key</span>
862:     <span class="ruby-identifier">server</span> = <span class="ruby-identifier">get_server_for_key</span> <span class="ruby-identifier">cache_key</span>
863:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>
864:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000153"></a><b>with_server</b>(key) {|server, cache_key| ...}
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000153_source')" id="l_M000153_source">show source</a> ]</p>
  <div id="M000153_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 824</span>
824:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">with_server</span>(<span class="ruby-identifier">key</span>)
825:     <span class="ruby-identifier">retried</span> = <span class="ruby-keyword kw">false</span>
826:     <span class="ruby-keyword kw">begin</span>
827:       <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span> = <span class="ruby-identifier">request_setup</span>(<span class="ruby-identifier">key</span>)
828:       <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">server</span>, <span class="ruby-identifier">cache_key</span>
829:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IndexError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
830:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> { <span class="ruby-node">&quot;Server failed: #{e.class.name}: #{e.message}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
831:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">retried</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@servers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
832:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> { <span class="ruby-node">&quot;Connection to server #{server.inspect} DIED! Retrying operation...&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
833:         <span class="ruby-identifier">retried</span> = <span class="ruby-keyword kw">true</span>
834:         <span class="ruby-keyword kw">retry</span>
835:       <span class="ruby-keyword kw">end</span>
836:       <span class="ruby-identifier">handle_error</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">e</span>)
837:     <span class="ruby-keyword kw">end</span>
838:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000152"></a><b>with_socket_management</b>(server, &amp;block)
  </div>
  <div class="description">
  <p>
Gets or creates a socket connected to the given server, and yields it to
the block, wrapped in a mutex synchronization if @multithread is true.
</p>
<p>
If a socket error (SocketError, SystemCallError, IOError) or protocol error
(<a href="MemCache/MemCacheError.html">MemCacheError</a>) is raised by the
block, closes the socket, attempts to connect again, and retries the block
(once). If an error is again raised, reraises it as <a
href="MemCache/MemCacheError.html">MemCacheError</a>.
</p>
<p>
If unable to connect to the server (or if in the reconnect wait period),
raises <a href="MemCache/MemCacheError.html">MemCacheError</a>. Note that
the socket connect code marks a server dead for a timeout period, so
retrying does not apply to connection attempt failures (but does still
apply to unexpectedly lost connections etc.).
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000152_source')" id="l_M000152_source">show source</a> ]</p>
  <div id="M000152_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activesupport/lib/active_support/vendor/memcache-client-1.7.4/memcache.rb, line 793</span>
793:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">with_socket_management</span>(<span class="ruby-identifier">server</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
794:     <span class="ruby-identifier">check_multithread_status!</span>
795: 
796:     <span class="ruby-ivar">@mutex</span>.<span class="ruby-identifier">lock</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multithread</span>
797:     <span class="ruby-identifier">retried</span> = <span class="ruby-keyword kw">false</span>
798: 
799:     <span class="ruby-keyword kw">begin</span>
800:       <span class="ruby-identifier">socket</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">socket</span>
801: 
802:       <span class="ruby-comment cmt"># Raise an IndexError to show this server is out of whack. If were inside</span>
803:       <span class="ruby-comment cmt"># a with_server block, we'll catch it and attempt to restart the operation.</span>
804: 
805:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">IndexError</span>, <span class="ruby-node">&quot;No connection to server (#{server.status})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">nil?</span>
806: 
807:       <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">socket</span>)
808: 
809:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SocketError</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EAGAIN</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
810:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> { <span class="ruby-node">&quot;Socket failure: #{err.message}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
811:       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">mark_dead</span>(<span class="ruby-identifier">err</span>)
812:       <span class="ruby-identifier">handle_error</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">err</span>)
813: 
814:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">MemCacheError</span>, <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
815:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> { <span class="ruby-node">&quot;Generic failure: #{err.class.name}: #{err.message}&quot;</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>
816:       <span class="ruby-identifier">handle_error</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">err</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">retried</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">nil?</span>
817:       <span class="ruby-identifier">retried</span> = <span class="ruby-keyword kw">true</span>
818:       <span class="ruby-keyword kw">retry</span>
819:     <span class="ruby-keyword kw">end</span>
820:   <span class="ruby-keyword kw">ensure</span>
821:     <span class="ruby-ivar">@mutex</span>.<span class="ruby-identifier">unlock</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multithread</span>
822:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>